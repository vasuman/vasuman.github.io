<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title> 
DSL in Python -  aleph_null 
 </title>
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom Feed"/>
    

    <link rel="stylesheet" href="/static/blog.css"/>
    
<link rel="stylesheet" href="/static/pygments.css">


    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-40829655-2', 'auto');
      ga('send', 'pageview');
    </script>
    
    
  </head>
  <body>
    <div id="header">
        <a href="/"><h1> aleph_null </h1></a>
        <h2> Too many levels </h2>
    </div>
    <nav>
      <ul>
        
        <li>
          <a href="/posts/index.html">Posts</a>
        </li>
        
        <li>
          <a href="/stuff/index.html">Stuff</a>
        </li>
        
        <li>
          <a href="http://www.varav.in/atom.xml">
            <img class="feed-icon" src="/static/feed.png" alt="Feed"/>
          </a>
      </ul>
    </nav>
    <div id="content">
      
    <article class="std-format">
        <div class="post-header">
          <h1>DSL in Python</h1>
            <time datetime="2016-01-01">01 Jan 2016</time>
        </div>
        <p>This post was in my drafts folder for quite a while and I suddenly felt the urge
to publish it. A while back <a href="https://github.com/vasuman/snek-lang">wrote a DSL</a> built on Python for some
college-related work. The goals for this exercise included syntax similarity
and a runtime that is based in Python. So, here are a few notes on the experience.</p>
<h2>Tokenizer</h2>
<p>Arguably, one of the most prominent yet contentious points about the Python
syntax is it's whitespace sensitivity. What do you use? 1 tab, 2
spaces, 4 spaces, 2^16 spaces!! A sensible editor configuration usually shields
you from the quirks of this, but the point is that, indentation styles are not
standard, some prefer tabs others spaces.</p>
<p>Python's <code>tokenizer</code> module is pretty handy to help handle the indentation
problem. It does this by converting your source file to stream of tokens with
two special tokens -- namely <code>INDENT</code> and <code>DEDENT</code> marking the starts and ends
of indented blocks respectively. In my experience, these markers are equivalent
to the block delimiters in other languages -- usually braces (<code>{</code>, <code>}</code>).</p>
<h3>Example</h3>
<p>Let's say we want to introduce a special language construct to swap the values
held in two variables with a <code>x &lt;=&gt; y</code> infix operator.</p>
<p>Here is an example. Consider the following segment of
code,</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span>
</pre></div>


<p>On tokenizing this piece of code -- <em>as a string</em> stored in <code>s</code>,</p>
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">tokenize</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">tokenize</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
</pre></div>


<p>We get,</p>
<div class="codehilite"><pre>2,0-2,2:    NAME    &#39;def&#39;
2,3-2,7:    NAME    &#39;swap&#39;
2,7-2,8:    OP  &#39;(&#39;
2,8-2,9:    NAME    &#39;a&#39;
2,9-2,10:   OP  &#39;,&#39;
2,11-2,12:  NAME    &#39;b&#39;
2,12-2,13:  OP  &#39;)&#39;
2,13-2,14:  OP  &#39;:&#39;
2,14-2,15:  NEWLINE &#39;\n&#39;
3,0-3,1:    INDENT  &#39;\t&#39;
3,1-3,2:    NAME    &#39;a&#39;
3,3-3,4:    OP  &#39;&lt;&#39;
3,4-3,5:    OP  &#39;=&#39;
3,5-3,6:    OP  &#39;&gt;&#39;
3,7-3,8:    NAME    &#39;b&#39;
3,8-3,9:    NEWLINE &#39;\n&#39;
4,0-4,0:    DEDENT  &#39;&#39;
4,0-4,0:    ENDMARKER   &#39;&#39;
</pre></div>


<p>As you can see, the module takes care of the whitespace problem,
delimiting blocks clearly. An additional benefit of using this module
is that it,</p>
<ul>
<li>Extracts <strong>string literals</strong></li>
<li>Handles code <strong>comments</strong></li>
</ul>
<h2>Parsing</h2>
<p>The parser would simply generate equivalent Python Abstract Syntax Tree for
constructs in my language. Though, <a href="#">PEG</a>s are powerful, I found writing a
custom recursive descent parser was way more convenient, understandable and
helped in printing sensible error messages.</p>
<p>The <code>ast</code> module is a handy tool for handling ASTs.</p>
<p>While it is ideal to build an AST from ground up, my strategy for generating
was a bit hack-ish. I used string interpolation to generate Python source code
that was then <code>ast.parse</code>d.</p>
<p>For example, to generate code that swaps the values in two variables <code>a</code> and
<code>b</code>.</p>
<div class="codehilite"><pre><span class="n">src</span><span class="o">=</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">{0}, {1} = {1}, {0}</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">))</span>
</pre></div>


<h2><span class="mono">eval</span> is your friend</h2>
<p>Now that you have your Python AST what do you do with it? Well, you <code>compile</code>
it to generate a <code>code</code> object that can be evaluated.</p>
<div class="codehilite"><pre><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;&lt;generated-src&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
</pre></div>


<h3>Namespaces</h3>
<p>By manipulating the appropriate namespace dictionaries, you can change the
<code>globals</code> and the <code>locals</code> of the executed code. This is useful for injection
of required values and extraction of execution results.</p>
<h3>Example</h3>
<p>Setup the dictionaries,</p>
<div class="codehilite"><pre><span class="n">env_globals</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">env_locals</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>


<p>Inject parameters,</p>
<div class="codehilite"><pre><span class="n">env_locals</span><span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">env_locals</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>


<p>And execute.</p>
<div class="codehilite"><pre><span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">env_globals</span><span class="p">,</span> <span class="n">env_locals</span><span class="p">)</span>
<span class="k">print</span> <span class="n">env_locals</span>
</pre></div>
    </article>

    </div>
    <footer>
      <address>
        <a href="mailto:vasumanar@gmail.com">Vasuman R</a>
      </address>
      <div id="accounts">
        <ul>
          
          <li><a href="https://github.com/vasuman">GitHub</a></li>
          
          
        </ul>
      </div>
      <div id="creds">
        Generated using, <a href="https://github.com/vasuman/glob">glob</a>
      </div>
    </footer>
  </body>
</html>